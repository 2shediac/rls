define(["jquery","core/yui"],function(a,b){return M.local_rlsiteadmin=M.local_rlsiteadmin||{},M.local_rlsiteadmin={data_actions:{add:{},remove:{},update:{}},data_addons:{},data_filters:{group:{},status:{},string:{},trust:{},type:{}},data_groups:{},plugin_modal:null,plugin_rate_node:null,plugin_types:{auth:{type:"auth",title:M.util.get_string("title_auth","local_rlsiteadmin"),icon:"fa-key"},block:{type:"block",title:M.util.get_string("title_block","local_rlsiteadmin"),icon:"fa-cube"},calendartype:{type:"calendartype",title:M.util.get_string("title_calendartype","local_rlsiteadmin"),icon:"fa-calendar"},enrol:{type:"enrol",title:M.util.get_string("title_enrol","local_rlsiteadmin"),icon:"fa-group"},filter:{type:"filter",title:M.util.get_string("title_filter","local_rlsiteadmin"),icon:"fa-filter"},format:{type:"format",title:M.util.get_string("title_format","local_rlsiteadmin"),icon:"fa-columns"},gradeexport:{type:"gradeexport",title:M.util.get_string("title_gradeexport","local_rlsiteadmin"),icon:"fa-download"},local:{type:"local",title:M.util.get_string("title_local","local_rlsiteadmin"),icon:"fa-home"},mod:{type:"mod",title:M.util.get_string("title_module","local_rlsiteadmin"),icon:"fa-puzzle-piece"},plagiarism:{type:"plagiarism",title:M.util.get_string("title_plagiarism","local_rlsiteadmin"),icon:"fa-eye"},qtype:{type:"qtype",title:M.util.get_string("title_qtype","local_rlsiteadmin"),icon:"fa-question"},report:{type:"qtype",title:M.util.get_string("title_report","local_rlsiteadmin"),icon:"fa-file-text-o"},repository:{type:"repository",title:M.util.get_string("title_repository","local_rlsiteadmin"),icon:"fa-folder-open"},theme:{type:"theme",title:M.util.get_string("title_theme","local_rlsiteadmin"),icon:"fa-picture-o"},tinymce:{type:"tinymce",title:M.util.get_string("title_tinymce","local_rlsiteadmin"),icon:"fa-text-height"}},action_dropdown_update:function(){function a(a){a.preventDefault();var c=a.target,d=c.ancestor("li").getAttribute("data-key"),g=c.ancestor("li").getAttribute("data-action"),h=b.one('.plugin.well[data-key="'+d+'"] button[data-action="'+g+'"]');b.log("remove_action"),b.log(a.target),delete M.local_rlsiteadmin.data_actions[g][d],b.log("attempted to delete relevant action node, displaying new data_actions object below"),b.log(M.local_rlsiteadmin.data_actions),0===Object.keys(M.local_rlsiteadmin.data_actions.add).length&&0===Object.keys(M.local_rlsiteadmin.data_actions.remove).length&&0===Object.keys(M.local_rlsiteadmin.data_actions.update).length&&(b.one("ul#plugin-actions").setStyle("display","none"),e.hasClass("disabled")||e.addClass("disabled"),f.hasClass("disabled")||f.addClass("disabled")),c.ancestor("li").remove(!0),h.hasClass("disabled")&&h.removeClass("disabled")}b.log("update_dropdown");var c,d=b.one("ul#plugin-actions"),e=b.one("button.plugin-actions"),f=b.one("#go-update-plugins");return b.log(d),d.detach("click"),0===Object.keys(M.local_rlsiteadmin.data_actions.add).length&&0===Object.keys(M.local_rlsiteadmin.data_actions.remove).length&&0===Object.keys(M.local_rlsiteadmin.data_actions.update).length?(c=d.all("li"),c.size()&&d.empty(),e.hasClass("disabled")||e.addClass("disabled"),f.hasClass("disabled")||f.addClass("disabled"),!1):(Object.keys(M.local_rlsiteadmin.data_actions.add).length>0&&(d.all('[data-action="add"]').remove(!0),b.Object.each(M.local_rlsiteadmin.data_actions.add,function(a,b){var c;c='<li data-action="add" ',c+='data-key="'+b+'">',c+='<i class="fa fa-plus" alt="'+M.util.get_string("to_be_added","local_rlsiteadmin")+'"></i>',c+=M.local_rlsiteadmin.data_addons[b].display_name,c+='<i class="fa fa-times-circle rm-action" alt="'+M.util.get_string("remove_action","local_rlsiteadmin")+'"></i>',c+="</li>",d.append(c)}),e.hasClass("disabled")&&(b.log("dropbtn has disabled class"),e.removeClass("disabled")),f.hasClass("disabled")&&(b.log("updatebtn has disabled class"),f.removeClass("disabled"))),Object.keys(M.local_rlsiteadmin.data_actions.remove).length>0&&(d.all('[data-action="remove"]').remove(!0),b.Object.each(M.local_rlsiteadmin.data_actions.remove,function(a,b){var c;c='<li data-action="remove" ',c+='data-key="'+b+'">',c+='<i class="fa fa-times" alt="'+M.util.get_string("to_be_added","local_rlsiteadmin")+'"></i>',c+=M.local_rlsiteadmin.data_addons[b].display_name,c+='<i class="fa fa-times-circle rm-action" alt="'+M.util.get_string("remove_action","local_rlsiteadmin")+'"></i>',c+="</li>",d.append(c)}),e.hasClass("disabled")&&(b.log("dropbtn has disabled class"),e.removeClass("disabled")),f.hasClass("disabled")&&(b.log("updatebtn has disabled class"),f.removeClass("disabled"))),Object.keys(M.local_rlsiteadmin.data_actions.update).length>0&&(d.all('[data-action="update"]').remove(!0),b.Object.each(M.local_rlsiteadmin.data_actions.update,function(a,b){var c;c='<li data-action="update" ',c+='data-key="'+b+'">',c+='<i class="fa fa-level-up" alt="'+M.util.get_string("to_be_updated","local_rlsiteadmin")+'"></i>',c+=M.local_rlsiteadmin.data_addons[b].display_name,c+='<i class="fa fa-times-circle rm-action" alt="'+M.util.get_string("remove_action","local_rlsiteadmin")+'"></i>',c+="</li>",d.append(c)}),e.hasClass("disabled")&&(b.log("dropbtn has disabled class"),e.removeClass("disabled")),f.hasClass("disabled")&&(b.log("updatebtn has disabled class"),f.removeClass("disabled"))),d.delegate("click",a,".rm-action"),b.log("add length"),void b.log(Object.keys(M.local_rlsiteadmin.data_actions.add).length))},addons_button_init:function(){function a(a){a.preventDefault();var c=a.target,d=c.ancestor(".plugin.well").getAttribute("data-key"),e=c.getAttribute("data-action");c.hasClass("disabled")||(b.log(c),b.log("Button "+e+" started for "+d),e in M.local_rlsiteadmin.data_actions?(M.local_rlsiteadmin.data_actions[e][d]=d,b.log(M.local_rlsiteadmin.data_actions)):b.log("Unknown action requested: "+e),c.addClass("disabled"),M.local_rlsiteadmin.action_dropdown_update())}function c(a){a.preventDefault();var c,e,f,g,h="<ul>"+M.util.get_string("plugins_will_be_added","local_rlsiteadmin"),i="",j={};for(e in M.local_rlsiteadmin.data_actions.add)h+="<li>"+e+"</li>";h+="</ul>",h+="<ul>"+M.util.get_string("plugins_will_be_updated","local_rlsiteadmin");for(e in M.local_rlsiteadmin.data_actions.update)h+="<li>"+e+"</li>";h+="</ul>",h+="<ul>"+M.util.get_string("plugins_will_be_removed","local_rlsiteadmin");for(e in M.local_rlsiteadmin.data_actions.remove)h+="<li>"+e+"</li>";h+="</ul>",b.log(h),c='<div id="modal-content">',c+="<h4>"+M.util.get_string("preparing_actions","local_rlsiteadmin")+"</h4>",c+="<p>"+h+"</p>",c+='<div id="action-results"><i class="fa fa-spinner fa-spin fa-4"></i></div>',c+="</div>",YUI().use("panel",function(a){M.local_rlsiteadmin.plugin_modal=new a.Panel({srcNode:"<div></div>",id:"manage-actions-modal",headerContent:M.util.get_string("actions_in_progress","local_rlsiteadmin"),bodyContent:c,buttons:[{id:"modal-confirm-button",label:M.util.get_string("confirm","local_rlsiteadmin"),section:"footer",action:function(b){b.preventDefault(),b.target.hide(),a.one("#manage-actions-modal .modal-cancel-button").set("label",M.util.get_string("close","local_rlsiteadmin")),d(b)},classNames:"modal-confirm-button",disabled:!0},{id:"modal-cancel-button",label:M.util.get_string("cancel","local_rlsiteadmin"),section:"footer",action:function(a){a.preventDefault(),M.local_rlsiteadmin.plugin_modal.hide(),M.local_rlsiteadmin.plugin_modal.destroy()},classNames:"modal-cancel-button",disabled:!0}],classNames:"manage-actions-modal",width:"60%",height:500,zIndex:1e4,centered:!0,modal:!0,visible:!0,render:!0})}),b.Object.each(M.local_rlsiteadmin.data_actions.add,function(a,c){b.log("Loop through add actions."),"object"==typeof M.local_rlsiteadmin.data_addons[c].cache&&"dependencies"in M.local_rlsiteadmin.data_addons[c].cache&&b.Object.each(M.local_rlsiteadmin.data_addons[c].cache.dependencies,function(a,b){b in M.local_rlsiteadmin.data_addons&&!(M.local_rlsiteadmin.data_addons[b].installed||b in M.local_rlsiteadmin.data_actions.add)&&(M.local_rlsiteadmin.data_actions.add[b]=b,j={source:c,target:b},i+="<li>"+M.util.get_string("dependency_will_be_added","local_rlsiteadmin",j)+"</li>")})}),b.Object.each(M.local_rlsiteadmin.data_actions.update,function(a,c){b.log("Loop through update actions."),"object"==typeof M.local_rlsiteadmin.data_addons[c].cache&&"dependencies"in M.local_rlsiteadmin.data_addons[c].cache&&b.Object.each(M.local_rlsiteadmin.data_addons[c].cache.dependencies,function(a,b){b in M.local_rlsiteadmin.data_addons&&!(M.local_rlsiteadmin.data_addons[b].installed||b in M.local_rlsiteadmin.data_actions.add)&&(M.local_rlsiteadmin.data_actions.update[b]=b,j={source:c,target:b},i+="<li>"+M.util.get_string("dependency_will_be_added","local_rlsiteadmin",j)+"</li>")})}),b.Object.each(M.local_rlsiteadmin.data_actions.remove,function(a,c){b.log("Loop through remove actions."),b.Object.each(M.local_rlsiteadmin.data_addons,function(a,b){"undefined"!=typeof a.dependencies&&a.dependencies[c]&&(b in M.local_rlsiteadmin.data_actions.remove||(M.local_rlsiteadmin.data_actions.remove[b]=b,j={source:c,target:b},i+="<li>"+M.util.get_string("dependency_will_be_removed","local_rlsiteadmin",j)+"</li>"))})}),i.length<=0&&(i="<li>"+M.util.get_string("no_dependencies","local_rlsiteadmin")+"</li>"),b.log(i),i="<h4>"+M.util.get_string("dependencies","local_rlsiteadmin")+"</h4>\n<ul>"+i+"</ul>",b.one("#action-results").insert(i,"before"),M.local_rlsiteadmin.action_dropdown_update(),b.one("#modal-content .fa-spinner").hide(),g=b.one("#manage-actions-modal .modal-confirm-button"),g.set("disabled",!1),g.removeClass("yui3-button-disabled"),g=b.one("#manage-actions-modal .modal-cancel-button"),g.set("disabled",!1),g.removeClass("yui3-button-disabled"),f='<h4 id="status-header"></h4>\n',f+='<div id="status-bar" class="progress"><div class="bar" style="width: 0%;"></div></div>\n',b.one("#action-results").insert(f,"before"),b.one("#status-bar").hide()}function d(a){function c(a){b.log("update_modal");var c=M.util.get_string("status_header_"+a,"local_rlsiteadmin"),d=0,f=2;switch(b.one("#status-bar").show(),a){case"waiting":d=2,f=10;break;case"running":d=0,f=90}e<d&&(e=d),e=d+e+(f-d-e)/10,b.one("#status-bar .bar").setStyle("width",e+"%"),b.one("#status-header").setHTML(c,"before")}function d(a,c){b.log("finish_modal"),b.log(a);var d,e,f,h="",i="";if(d=a?"success":"failure",b.one("#status-header").remove(),b.one("#status-bar").remove(),e=c.length,e>0){for(f=0;f<e;f+=1)h+="<li>"+c[f]+"</li>\n";h="<ul>"+h+"</ul>\n"}if(e=g.length,e>0){for(f=0;f<e;f+=1)i+="<li>"+g[f]+"</li>\n";i="<ul>"+M.util.get_string("plugins_require_configuration","local_rlsiteadmin")+"</ul>\n<ul>"+i+"</ul>\n<ul>"+M.util.get_string("plugins_need_help","local_rlsiteadmin")+"</ul>\n"}h="<h4>"+M.util.get_string(d,"local_rlsiteadmin")+"</h4>\n<ul>"+M.util.get_string("actions_completed_"+d,"local_rlsiteadmin")+"</ul>\n"+h+i,b.one("#action-results").insert(h,"before"),b.one("#modal-content .fa-spinner").hide(),$button=b.one("#manage-actions-modal button"),$button.set("disabled",!1),$button.removeClass("yui3-button-disabled")}a.preventDefault();var e=0,f="",g=[];b.log("Loop through add actions."),b.Object.each(M.local_rlsiteadmin.data_actions.add,function(a,c){b.log(c+" -> "+a),f.length>0&&(f+="&"),f+="add[]="+c,5===M.local_rlsiteadmin.data_addons[c].source&&(g[g.length]=c)}),b.log("Loop through update actions."),b.Object.each(M.local_rlsiteadmin.data_actions.update,function(a,b){f.length>0&&(f+="&"),f+="update[]="+b}),b.log("Loop through remove actions."),b.Object.each(M.local_rlsiteadmin.data_actions.remove,function(a,b){f.length>0&&(f+="&"),f+="remove[]="+b}),b.log("data = "+f),YUI().use("io-base",function(a){var b=M.cfg.wwwroot+"/local/rlsiteadmin/mass/action.php",e={method:"POST",data:f,on:{success:function(b,e){function f(){YUI().use("io-base",function(a){var b=M.cfg.wwwroot+"/local/rlsiteadmin/mass/addonstatus.php?addoncommand="+h.file+"&hash="+h.hash,d={method:"GET",on:{success:function(a,b){var d=null;YUI().use("json-parse",function(a){try{d=a.JSON.parse(b.responseText);var e="waiting";d.running?e="running":!d.running&&d.fileexists===!1&&d.results&&(e="completed"),"completed"!=e?(c(e),setTimeout(function(){f()},2e3)):(h.results=d.results,g())}catch(i){a.log("Parsing failed.")}})},failure:function(b,c){if("503"==c.status)return void setTimeout(function(){f()},2e3);try{$status=a.JSON.parse(c.responseText),g()}catch(d){a.log("Parsing failed.")}}}};$addons=a.io(b,d)})}function g(){a.log(h);var b=!1;if("undefined"==typeof h.results&&(h.results=""),"undefined"==typeof h.messages&&(h.messages=[]),""==typeof h.results&&"undefined"!=typeof h.messages[0]){h.results="";for(var c=0;c<h.messsages.length;c++)h.results+=h.messsages[c]+"<br>"}h.results=h.results.toLowerCase(),h.messages[0]||void 0!==h.results&&(h.results.indexOf("unable")!=-1||h.results.indexOf("failed")!=-1)?a.log("JSON response reports a failure."):(b=!0,a.log("JSON response is success.")),Object.keys(M.local_rlsiteadmin.data_actions.add).length>0&&a.Object.each(M.local_rlsiteadmin.data_actions.add,function(a,b){delete M.local_rlsiteadmin.data_actions.add[b]}),Object.keys(M.local_rlsiteadmin.data_actions.remove).length>0&&a.Object.each(M.local_rlsiteadmin.data_actions.remove,function(a,b){delete M.local_rlsiteadmin.data_actions.remove[b]}),Object.keys(M.local_rlsiteadmin.data_actions.update).length>0&&a.Object.each(M.local_rlsiteadmin.data_actions.update,function(a,b){delete M.local_rlsiteadmin.data_actions.update[b]}),M.local_rlsiteadmin.action_dropdown_update(),d(b,h)}a.log("do_actions success");var h=null;YUI().use("json-parse",function(a){try{h=a.JSON.parse(e.responseText)}catch(b){a.log("Parsing failed.")}}),f()},failure:function(){a.log("Action failure."),a.one("#manage-actions-modal button").set("disabled",!1),a.one("#modal-content fa-spinner").hide()}}};$addons=a.io(b,e)})}function e(a){b.log("Toggle the actions!");var c=b.one("ul#plugin-actions");b.one("button.plugin-actions").hasClass("disabled")||"none"!==c.getStyle("display")?c.setStyle("display","none"):c.setStyle("display","block"),c.get("parentNode").toggleClass("open")}var f=b.one(".plugins");f.delegate("click",a,"button.btn-install"),f.delegate("click",a,"button.btn-remove"),f.delegate("click",a,"button.btn-update"),b.one("#go-update-plugins").on("click",c),b.one("button.plugin-actions").on("click",e),b.one("ul#plugin-actions").on("mouseleave",e)},addons_upgrademethod_init:function(){b.Object.each(M.local_rlsiteadmin.data_addons,function(a,c){var d,e,f=String(a.name).replace(" ","_"),g=["manual","auto"],h=a.type+"_"+f;for(e=0;e<g.length;e++)d=b.one("#"+h+"_"+g[e]),d&&(b.log("select event for "+h+"_"+g[e]),d.delegate("click",function(a){var c=a.target.get("value"),d=a.target.get("id").replace(/_manual$|_auto$/,"");b.log("upgrade method set to "+c+" for "+d),M.local_rlsiteadmin.addons_upgrademethod_send(d,c)},"input[type=radio]"))}),b.one("#upgradesettings_all_auto").on("click",function(a){var c="";b.all(".pluginupgradesetting .upgradeauto input").each(function(a){a.get("checked")||(c=c+","+a.get("id").replace(/_manual$|_auto$/,""))}),b.all(".pluginupgradesetting .upgradeauto input").each(function(a){a.get("checked")||a.set("checked","true")}),M.local_rlsiteadmin.addons_upgrademethod_send(c,"auto")}),b.one("#upgradesettings_all_manual").on("click",function(){var a="";b.all(".pluginupgradesetting .upgrademanual input").each(function(b){b.get("checked")||(a=a+","+b.get("id").replace(/_manual$|_auto$/,""))}),b.all(".pluginupgradesetting .upgrademanual input").each(function(a){a.get("checked")||a.set("checked","true")}),M.local_rlsiteadmin.addons_upgrademethod_send(a,"manual")})},addons_fetch:function(){b.log("addons_fetch"),M.local_rlsiteadmin.ajax_fetch("addon",M.local_rlsiteadmin.addons_update)},addons_update:function(c){b.log("addons_update"),M.local_rlsiteadmin.data_addons=c,disp=a('input[name="display-order"]:checked').val(),M.local_rlsiteadmin.addons_sort(disp),M.local_rlsiteadmin.addons_write(),M.local_rlsiteadmin.filter_plugins()},addons_rate:function(){function a(a){if(a.preventDefault(),$this=a.target,M.local_rlsiteadmin.plugin_rate_node&&$this===M.local_rlsiteadmin.plugin_rate_node)return b.log("Conditions not met. M.local_rlsiteadmin.plugin_rate_node not null or matches existing e.target."),!1;b.log("M.local_rlsiteadmin.plugin_rate_node is null"),M.local_rlsiteadmin.plugin_rate_node=$this,$starset=M.local_rlsiteadmin.plugin_rate_node.get("parentNode").get("children").filter(".fa"),$clickedindex=$starset.indexOf(M.local_rlsiteadmin.plugin_rate_node),$fillstars=$starset.slice(0,$clickedindex+1),$emptystars=$starset.slice($clickedindex+1,$starset.size()+1);var c=$clickedindex+1,d=M.local_rlsiteadmin.plugin_rate_node.ancestor(".plugin.well").getAttribute("data-key");$starset.each(function(a){a.hasClass("fa-star-o")&&a.removeClass("fa-star-o"),a.hasClass("fa-star")&&a.removeClass("fa-star"),$starset.indexOf(a)===$starset.size()-1&&($emptystars.addClass("fa-star-o"),$fillstars.addClass("fa-star"),M.local_rlsiteadmin.addons_rating_send(d,c))})}b.one(".plugins").delegate("click",a,".rate-plugin .fa-star-o, .rate-plugin .fa-star")},addons_rating_send:function(a,c){b.log("addon = "+a),b.log("rating = "+c),YUI().use("io-base",function(b){var d=M.cfg.wwwroot+"/local/rlsiteadmin/mass/rate.php",e={method:"POST",data:"addon="+a+"&rating="+c,on:{success:function(a,c){b.log("success");var d=null;YUI().use("json-parse",function(a){try{d=a.JSON.parse(c.responseText)}catch(b){a.log("Parsing failed.")}}),b.log("$response = "),b.log(d)},failure:function(){b.log("Ratings failure.")}}};$addons=b.io(d,e)})},addons_upgrademethod_send:function(a,c){b.log("addon = "+a),b.log("method = "+c),YUI().use("io-base",function(b){var d=M.cfg.wwwroot+"/local/rlsiteadmin/mass/pluginsettings.php",e={method:"POST",data:"addon="+a+"&upgrademethod="+c,on:{success:function(a,c){b.log("success");var d=null;YUI().use("json-parse",function(a){try{d=a.JSON.parse(c.responseText)}catch(b){a.log("Parsing failed. $response = "),a.log(d)}})},failure:function(){b.log("Update settings failure.")}}};$addons=b.io(d,e)})},addons_sort:function(c){function d(b,c,d){var e={},f=d[b],g=-1,h=0;return delete d[b],"undefined"!=typeof c&&null!=c||(c=""),a.each(d,function(a,d){(""===c&&0===h||1===g)&&(e[b]=f,g=0),a===c&&(g=1),e[a]=d,++h}),1===g&&(e[b]=f),g!==-1?e:d}var e,f;b.log("addons_sort");var g=[];switch(c){case"alpha":b.Object.each(M.local_rlsiteadmin.data_addons,function(a,b){$k=b,$disp=a.display_name,$disp=M.local_rlsiteadmin.capitalise_firstletter($disp),g.push([$k,$disp])});break;case"type":b.Object.each(M.local_rlsiteadmin.data_addons,function(a,b){$k=b,$disp=a.type,g.push([$k,$disp])});break;case"release":b.Object.each(M.local_rlsiteadmin.data_addons,function(a,b){$k=b,$disp=a.cache.version?a.cache.version:0,g.push([$k,$disp])})}if(g.length>0)for("release"===c?g.sort(function(a,b){return a[1]>b[1]?-1:a[1]<b[1]?1:0}):g.sort(function(a,b){return a[1]<b[1]?-1:a[1]>b[1]?1:0}),prev=g[0][0],M.local_rlsiteadmin.data_addons=d(prev,"",M.local_rlsiteadmin.data_addons),e=g.length,f=1;f<e;f++)newkey=g[f][0],M.local_rlsiteadmin.data_addons=d(newkey,prev,M.local_rlsiteadmin.data_addons),prev=newkey},addons_write:function(){$tothtml="",b.one(".plugins .loading-spinner").hide(),$newhtml='<div class="display-plugins">',b.one(".plugin-select .plugins").insert($newhtml),b.Object.each(M.local_rlsiteadmin.data_addons,function(a,c){var d,e,f=!!a.installed&&a.installed,g=!!a.missing&&a.missing,h=!!a.paid&&a.paid,i=!!a.upgradeable&&a.upgradeable,j=!!a.cached&&a.cached,k=!!a.locked&&a.locked,l=a.display_name?a.display_name:M.util.get_string("plugin_name_not_available","local_rlsiteadmin"),m=a.description?a.description:M.util.get_string("plugin_description_not_available","local_rlsiteadmin"),n=a.myrating?a.myrating:0,o=a.rating?a.rating:0,p=a.moodleversions?a.moodleversions:"",q=a.type?a.type:"1",r=" type-"+q,s=" name-"+String(a.name).replace(" ","_"),t='data-key="'+String(c).replace(" ","_")+'" ',u='data-installed="'+String(f).replace(" ","_")+'" ',v='data-updateable="'+String(i).replace(" ","_")+'" ',w='data-cached="'+String(j).replace(" ","_")+'" ',x='data-type="'+String(q).replace(" ","_")+'" ',y=["install"],z=[],A="",B=["fa","fa-plus"];for(b.log(c+" install (default)"),k?(b.log("locked"),y[0]="locked"):g?(y[0]="repair",y[1]="uninstall",b.log("missing")):f?(y[0]="uninstall",i&&(y[1]="update"),b.log("installed")):h&&(b.log("paid"),y[0]="pricing"),e=0;e<y.length;e+=1){var C="add",D=["btn","btn-block","btn-install","btn-success"],E="add",F="button";switch(y[e]){case"install":break;case"repair":C="repair",B[1]="fa-wrench",D[3]="btn-primary";break;case"locked":C="locked",E="",F="div",D=["text-center"],B[1]="fa-lock";break;case"uninstall":C="remove",D[2]="btn-remove",D[3]="btn-danger",E="remove",B[1]="fa-times";break;case"update":C="update",D[2]="btn-update",D[3]="btn-primary",E="update",B[1]="fa-level-up";break;case"pricing":C="for_pricing",E="",F="div",D=["text-center"],B=[]}var G=M.util.get_string(C,"local_rlsiteadmin");A="<"+F+' type="button" class="'+D.join(" ")+'" data-action="'+E+'">',A+='<i class="'+B.join(" ")+'"></i>',A+=G,A+="</"+F+">",z[z.length]=A}for($ratingmarkup='<div class="avg-rating"><h5>'+M.util.get_string("average_rating","local_rlsiteadmin")+"</h5>",e=1;e<6;e++)e<=o?$ratingmarkup+='<i class="fa fa-star"></i>':$ratingmarkup+='<i class="fa fa-star-o"></i>';$ratingmarkup+="</div>",B="fa-plug",q in M.local_rlsiteadmin.plugin_types&&(B=M.local_rlsiteadmin.plugin_types[q].icon),versionmarkup="";for(d in p)versionmarkup+='<span class="available-version">',"Y"===p[d]?versionkey=d:versionkey="&nbsp;&nbsp;&nbsp;",versionmarkup+=versionkey+"</span>";for(availablemarkup='<div class="available"><h5>'+M.util.get_string("available_for","local_rlsiteadmin")+"</h5>",availablemarkup+=versionmarkup,availablemarkup+="</div>",$itemmarkup='<ul class="media-list"><li class="media">',$itemmarkup+='<i class="pull-left plugin-type fa '+B+'"></i>',$itemmarkup+='<div class="media-body">',$itemmarkup+='<h3 class="media-heading">'+l+"</h3>",$itemmarkup+="<p>"+m+"</p>",$itemmarkup+='<div class="rate-plugin">',$itemmarkup+="<p><strong>"+M.util.get_string("add_or_update_rating_bold","local_rlsiteadmin")+"</strong>"+M.util.get_string("add_or_update_rating_normal","local_rlsiteadmin")+"</p>",e=1;e<6;e++)e<=n?$itemmarkup+='<i class="fa fa-star" title="'+e+' stars"></i>':$itemmarkup+='<i class="fa fa-star-o" title="'+e+' stars"></i>';a.installed?a.upgrademethod=a.upgrademethod?a.upgrademethod:"manual":a.upgrademethod="auto";var H=String(a.name).replace(" ","_"),I=a.type+"_"+H;if(a.upgrademethodchangeable&&a.installed){pluginame="addonsetting_"+I,$itemmarkup+='<p class="pluginupgradesetting"><strong>'+M.util.get_string("updatesettings","local_rlsiteadmin")+"</strong>";var J="",K="";"manual"==a.upgrademethod?K=' checked="checked" ':J=' checked="checked" ',$itemmarkup+='&nbsp;<label class="upgrademanual" for="'+I+'_manual"><input class="upgrademanual" type="radio" name="upgrademethod_'+I+'" id="'+I+'_manual" value="manual" '+K+"/>",$itemmarkup+=M.util.get_string("updatesettings_manual","local_rlsiteadmin")+"</label>",$itemmarkup+='&nbsp;<label class="upgradeauto" for="'+I+'_auto"><input class="upgradeauto" type="radio" name="upgrademethod_'+I+'" id="'+I+'_auto" value="auto" '+J+"/>",$itemmarkup+=M.util.get_string("updatesettings_auto","local_rlsiteadmin")+"</label>"}$itemmarkup+="</div>",$itemmarkup+="</div>",$itemmarkup+="</li></ul>",$html='<div class="clearfix plugin well'+r+s+'" '+t+u+v+w+x+' style="display: none;" hidden="hidden">',$html+='<div class="choose">',$html+=z.join(" "),$html+=$ratingmarkup,$html+=availablemarkup,$html+="</div>",$html+=$itemmarkup,$html+="</div>",$tothtml+=$html,b.one(".plugin-select .plugins").insert($html)}),$newhtml="</div>",b.one(".plugin-select .plugins").insert($newhtml),M.local_rlsiteadmin.addons_rate(),M.local_rlsiteadmin.addons_button_init(),M.local_rlsiteadmin.addons_upgrademethod_init()},ajax_fetch:function(a,c){b.log("ajax_fetch"),YUI().use("io-base",function(b){function d(){b.log("complete")}function e(a,d){b.log("ajax_fetch success");var e=null,f=d.responseText.match(/\{"(addons|groups)":[\[{].*[\]}]}/m);return null===f?void b.log("Unable to load data from "+$url+": "+d.responseText):(b.log(f),YUI().use("json-parse",function(a){try{e=a.JSON.parse(f[0])}catch(b){a.log("Parsing failed."),a.log(b)}}),void c(e.addons))}function f(a){b.log("Failure: "+a[0])}$url=M.cfg.wwwroot+"/local/rlsiteadmin/mass/addons.php?type="+a+"list",b.log($url),b.on("io:complete",d,b,[]),b.on("io:success",e,b,[]),b.on("io:failure",f,b,[M.util.get_string("ajax_request_failed","local_rlsiteadmin")]),$addons=b.io($url)})},capitalise_firstletter:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},filter_init:function(){M.local_rlsiteadmin.filter_clear(),M.local_rlsiteadmin.filter_text(),M.local_rlsiteadmin.addons_fetch(),M.local_rlsiteadmin.groups_fetch()},filter_add:function(a,c,d){$labelsbox=b.one("#labels-box"),"none"===$labelsbox.getStyle("display")&&$labelsbox.setStyle("display","block"),$filters=b.all("#filter-labels span.badge"),filterlist=$filters.get("text");var e=[];return b.Array.each(filterlist,function(a){e.push(a.trim())}),prefix=M.local_rlsiteadmin.capitalise_firstletter(c)+" | ",e.indexOf(prefix+a)<=-1&&(labelmarkup='<span class="badge" data-filter-mode="'+c+'" data-filter-refine="'+d+'">'+prefix+a+'<i class="fa fa-times" alt="'+M.util.get_string("remove_filter","local_rlsiteadmin")+'"></i></span>',$filters.length>=1?$item=$filters.item(filterlist.length-1).insert(labelmarkup,"after"):$item=b.one("#filter-labels").insert(labelmarkup),M.local_rlsiteadmin.filter_plugins(),M.local_rlsiteadmin.filter_remove(),M.local_rlsiteadmin.filter_block_show(),$item)},filter_column:function(){b.log("Setting up filter column."),b.all('#filter-form input[type="checkbox"]').on("change",function(a){b.log("Checkbox change");var c=b.one(a.currentTarget),d=c.getAttribute("data-filter-mode"),e=c.getAttribute("data-filter-refine"),f=!1;c.get("checked")&&(f=!0),b.log("$mode = "+d+" $refine = "+e+" value = "+f),M.local_rlsiteadmin.data_filters[d][e]=f,M.local_rlsiteadmin.filter_plugins()}),b.all('#filter-form input[type="radio"]').on("change",function(c){var d=b.one(c.currentTarget),e=d.getAttribute("value");M.local_rlsiteadmin.addons_fetch(),M.local_rlsiteadmin.addons_sort(e),M.local_rlsiteadmin.addons_write(),$tothtml='<div class="display-plugins">'+$tothtml+"</div>",a("div.display-plugins").replaceWith($tothtml)}),b.all("#filter-form div.toggle").on("click",function(a){a.preventDefault();var c=b.one(a.currentTarget),d=c.one(".fa");d.toggleClass("fa-chevron-down"),d.toggleClass("fa-chevron-right");var e=c.ancestor(".block"),f=e.one("> .content");f.toggleView()})},filter_clear:function(){$clearbutton=b.one("button#clear-filters"),$clearbutton.on("click",function(){b.all("#filter-labels span.badge").remove(!0),M.local_rlsiteadmin.filter_plugins(),M.local_rlsiteadmin.filter_block_hide()})},filter_block_show:function(){b.all("#filter-labels span.badge").size()>=1&&b.one("#labels-box").show(!0)},filter_block_hide:function(){b.all("#filter-labels span.badge").size()<=0&&(b.one("#labels-box").hide(!0),M.local_rlsiteadmin.filter_plugins())},filter_plugins:function(){function a(a){var c={},d=b.all("#filter-form ."+a+" input[type=checkbox]");return b.log("Getting starting "+a+" filters"),d.each(function(a){var d=a.getData("filter-refine"),e=a.get("checked");b.log("Checking filter "+d+"."),e&&(b.log("Filter "+d+" is active!"),c[d]=e)}),c}function c(){var a=b.one("#trust-filter").get("checked");if(!a)return b.log("Trust filter disabled, moving on to type."),!1;b.log("Trust filter enabled:");var c;return b.Object.each(h,function(a,b){c=!0,4!==a.source&&5!==a.source||(c=!1),c&&(a.filtered=!0)}),!0}function d(){var c=a("groups");if(Object.keys(c).length<=0)return b.log("Group filter list is empty, moving on to next."),!1;var d={};b.Object.each(h,function(a,b){d[b]=!0});var e=0;return b.Object.each(c,function(a,b){if(b in M.local_rlsiteadmin.data_groups)for(e=0;e<M.local_rlsiteadmin.data_groups[b].plugins.length;e+=1)d[M.local_rlsiteadmin.data_groups[b].plugins[e]]=!1}),b.Object.each(d,function(a,b){a&&!h[b].filtered&&(h[b].filtered=!0)}),!0}function e(){var c=a("statuses");if(Object.keys(c).length<=0)return b.log("Status filter list is empty, moving on to next."),!1;b.log("Status filters:"),b.log(c);var d;return b.Object.each(h,function(a,e){d=!0,b.Object.each(c,function(c,e){"installed"===e&&c&&a.installed?(b.log("type matches = "+c),d=!1):"notinstalled"===e&&c&&!a.installed?(b.log("type matches = "+c),d=!1):"updateable"===e&&c&&a.installed&&a.upgradeable?(b.log("type matches = "+c),d=!1):"repairable"===e&&c&&a.installed&&a.missing&&(b.log("type matches = "+c),d=!1)}),b.log("Status filter for "+e+": "+d),d&&(a.filtered=!0)}),!0}function f(){var c=a("types");if(Object.keys(c).length<=0)return b.log("Type filter disabled, moving on to status."),!1;b.log("Type filters enabled:");var d;return b.Object.each(h,function(a,e){d=!0,b.Object.each(c,function(c,e){b.log(a.type+" === "+e),c&&a.type===e&&(d=!1)}),b.log("Type filter for "+e+": "+d),d&&(a.filtered=!0)}),!0}function g(){var a=b.all("#filter-labels span.badge");if(M.local_rlsiteadmin.data_filters.string={},a.filter('[data-filter-mode="string"]').each(function(a){var c=b.one(a).getAttribute("data-filter-refine");M.local_rlsiteadmin.data_filters.string[c]=!0}),Object.keys(M.local_rlsiteadmin.data_filters.string).length<=0)return b.log("String filter list is empty, done."),!1;b.log("String filter enabled:");var c;return b.Object.each(h,function(a,d){heading=String(a.display_name).toLowerCase(),description=String(a.description).toLowerCase(),name=String(d).toLowerCase(),c=!1,b.Object.each(M.local_rlsiteadmin.data_filters.string,function(a,d){stringlowcaps=String(d).toLowerCase(),isinheading=heading.indexOf(stringlowcaps),isindesc=description.indexOf(stringlowcaps),isinname=name.indexOf(stringlowcaps),isinheading<0&&isindesc<0&&isinname<0?c=!0:b.log("string matches.")}),b.log("String filter for "+d+": "+c),c&&(a.filtered=!0)}),!0}b.log("filter_plugins"),b.all(".plugins .plugin.well").hide(!0),b.log(M.local_rlsiteadmin.data_filters);var h=JSON.parse(JSON.stringify(M.local_rlsiteadmin.data_addons));b.Object.each(h,function(a,b){a.filtered=!1}),b.log("Start filtering"),b.log(h),c(),d(),e(),f(),g(),b.Object.each(h,function(a,c){newkey=String(c).replace(" ","_"),selector='.plugin[data-key="'+newkey+'"]';var d=b.one(selector);d&&(a.filtered||d.show(!0))})},filter_remove:function(){$removebutton=b.all("#filter-labels i.fa-times"),$removebutton.on("click",function(a){var b=a.target.get("parentNode");$target=b.remove(!0),M.local_rlsiteadmin.filter_plugins(),M.local_rlsiteadmin.filter_block_hide()})},filter_text:function(){function a(){value=b.one("input#plugin-filter").get("value"),value.length>=1&&(M.local_rlsiteadmin.filter_add(value,"string",value),$input.set("value","")),M.local_rlsiteadmin.filter_block_show()}$input=b.one("input#plugin-filter"),$input.on("click",function(b){var c=b.target;c.set("value",""),c.on("key",a,"enter")})},groups_fetch:function(){b.log("groups_fetch"),M.local_rlsiteadmin.ajax_fetch("group",M.local_rlsiteadmin.groups_update),M.local_rlsiteadmin.groups_write()},groups_update:function(a){b.log("groups_fetch"),M.local_rlsiteadmin.data_groups=a,M.local_rlsiteadmin.groups_write(),M.local_rlsiteadmin.filter_column()},groups_write:function(){b.one("#filter-form .groups .loading-spinner").hide(),b.Object.each(M.local_rlsiteadmin.data_groups,function(a,c){var d=a.display_name?a.display_name:M.util.get_string("group_name_not_available","local_rlsiteadmin"),e='<label class="checkbox"><input type="checkbox" data-filter-mode="group" data-filter-refine="'+a.name+'">'+d+"</label>";b.one("#filter-form .groups .content").insert(e)})},update_continue_init:function(){b.one("#afterupdate").on("click",function(){b.one(".site-update").hide(!0,function(){b.one(".plugin-select").setStyle("display","block").hide().show(!0);
}),M.local_rlsiteadmin.filter_init()})},update_site_init:function(){b.one("#doupdate").on("click",function(a){b.log("Perform site sync clicked"),a.target.setAttribute("disabled"),b.one("#skipupdate").setAttribute("disabled"),b.one(".site-update-spinner").show(!0);var c=b.one(".site-update-spinner .fa-spinner"),d=b.one("div.instr-continue"),e=b.one("#afterupdate");YUI().use("io-base",function(a){var b=M.cfg.wwwroot+"/local/rlsiteadmin/mass/refresh.php",f={method:"POST",data:"",on:{success:function(b,f){a.log("Refresh ordered.");var g=null;YUI().use("json-parse",function(a){try{g=a.JSON.parse(f.responseText)}catch(b){a.log("Parsing failed."),a.log(b)}}),a.log("$response = "),a.log(g),c.hide(!0),d.show(!0),e.show(!0)},failure:function(){a.log("Refresh failed."),c.hide(!0)}}};a.io(b,f)}),b.log("Resume operation.")})},update_skip_init:function(){b.one("#skipupdate").on("click",function(){b.one(".site-update").hide(!0,function(){b.one(".plugin-select").setStyle("display","block").hide().show(!0)}),M.local_rlsiteadmin.filter_init()})},init:function(){b.log("Init function called:"),$update=b.one(".site-update"),$update?(b.log("Update found."),M.local_rlsiteadmin.update_continue_init(),M.local_rlsiteadmin.update_skip_init(),M.local_rlsiteadmin.update_site_init()):M.local_rlsiteadmin.filter_init()}},{init:function(){M.local_rlsiteadmin.init()}}});