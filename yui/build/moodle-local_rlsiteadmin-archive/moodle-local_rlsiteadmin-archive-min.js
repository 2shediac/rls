YUI.add("moodle-local_rlsiteadmin-archive",function(e,t){M.local_rlsiteadmin=M.local_rlsiteadmin||{},M.local_rlsiteadmin={data_snapshots:{},data_archives:{},data_restored:{},total_slots:Number(e.one("#rlarchives #numtotal").get("innerHTML")),available_slots:Number,used_slots:Number,ajax_status:{snapshots:!1,archives:!1},error_modal:null,bindings:{},snapshots_fetch:function(){YUI().use("io-base",function(e){function t(){}function n(e,t){var n=null,r=t.responseText.match(/\{"archiveapi":{.*\}}/m);if(r===null)return;YUI().use("json-parse",function(e){try{n=e.JSON.parse(r[0])}catch(t){}}),M.local_rlsiteadmin.data_snapshots=n.archiveapi.snapshots,M.local_rlsiteadmin.ajax_status.snapshots=!0,M.local_rlsiteadmin.snapshots_write()}function r(e){}e.on("io:complete",t,e,[]),e.on("io:success",n,e,[]),e.on("io:failure",r,e,[M.util.get_string("ajax_request_failed","local_rlsiteadmin")]);var i=M.cfg.wwwroot+"/local/rlsiteadmin/archive/apicall.php?request=listsnapshots";e.io(i)})},snapshots_write:function(){var t=0;e.Object.each(M.local_rlsiteadmin.data_snapshots,function(n,r){if(n.expiration>0){var i=e.one("#rlsnapshots .list"),s=e.one(".archive-manager .templates .snapshot"),o=s.cloneNode(!0).appendTo(i);o.setAttribute("data-snapshotid",n.id),o.one(".date").setHTML(n.date),o.one(".expiration-date").setHTML(n.expiration),t++,setTimeout(function(){o.removeClass("fadedout")},70*t)}}),$spinner=e.one("#rlsnapshots .spinner"),$spinner.hide(),M.local_rlsiteadmin.ajax_status.snapshots&&M.local_rlsiteadmin.ajax_status.archives&&M.local_rlsiteadmin.drag_and_drop_init()},archives_fetch:function(){YUI().use("io-base",function(e){function t(){}function n(e,t){var n=null,r=t.responseText.match(/\{"archiveapi":{.*\}}/m);if(r===null)return;YUI().use("json-parse",function(e){try{n=e.JSON.parse(r[0])}catch(t){}}),M.local_rlsiteadmin.data_archives=n.archiveapi.archives,M.local_rlsiteadmin.ajax_status.archives=!0,M.local_rlsiteadmin.archives_write()}function r(e){}e.on("io:complete",t,e,[]),e.on("io:success",n,e,[]),e.on("io:failure",r,e,[M.util.get_string("ajax_request_failed","local_rlsiteadmin")]);var i=M.cfg.wwwroot+"/local/rlsiteadmin/archive/apicall.php?request=listarchives";e.io(i)})},archives_write:function(){var t=0;e.Object.each(M.local_rlsiteadmin.data_archives.done,function(t,n){var r=e.one("#rlarchives .list"),i=e.one(".archive-manager .templates .archive"),s=i.cloneNode(!0).appendTo(r);s.setAttribute("data-archiveid",t.id),s.one(".date").setHTML(t.date),s.one(".status").setHTML(M.util.get_string("archive_status_ready","local_rlsiteadmin"))}),e.Object.each(M.local_rlsiteadmin.data_archives["in-progress"],function(t,n){var r=e.one("#rlarchives .list"),i=e.one(".archive-manager .templates .archive"),s=i.cloneNode(!0).appendTo(r);s.addClass("in-progress"),s.setAttribute("data-archiveid",t.id),s.one(".date").setHTML(t.date),s.one(".status").setHTML(M.util.get_string("archive_status_in_progress","local_rlsiteadmin"))}),M.local_rlsiteadmin.used_slots=M.local_rlsiteadmin.data_archives.done.length+M.local_rlsiteadmin.data_archives["in-progress"].length,M.local_rlsiteadmin.available_slots=M.local_rlsiteadmin.total_slots-M.local_rlsiteadmin.used_slots,e.one("#rlarchives #numused").setHTML(M.local_rlsiteadmin.used_slots);var n=Array();for(var r=0;r<M.local_rlsiteadmin.available_slots;r++)n.push(r);e.Object.each(n,function(t,n){var r=e.one("#rlarchives .list"),i=e.one(".archive-manager .templates .slot"),s=i.cloneNode(!0).appendTo(r)}),M.local_rlsiteadmin.discard_archive_init(),M.local_rlsiteadmin.ajax_status.snapshots&&M.local_rlsiteadmin.ajax_status.archives&&M.local_rlsiteadmin.drag_and_drop_init(),M.local_rlsiteadmin.restored_fetch()},drag_and_drop_init:function(){function t(){if(e.all("#rlarchives .slot-open").size()>0){var t=this.ancestor(".snapshot"),n=e.one("#rlarchives .slot-open");M.local_rlsiteadmin.setup_archive(t,n)}else M.local_rlsiteadmin.show_error("archive_error_no_slots_available")}$archives=e.all("#rlarchives .archive"),e.each($archives,function(e,t){e.addClass("slot-open")}),YUI().use("dd-drop","dd-proxy","dd-constrain",function(e){var t=e.one("#rlarchives .list").all(".slot-open");e.each(t,function(t,n){var r=new e.DD.Drop({node:t})});var n=e.one("#rlsnapshots .list").all(".snapshot");e.each(n,function(t,n){var r=(new e.DD.Drag({node:t})).plug(e.Plugin.DDProxy,{moveOnEnd:!1}).plug(e.Plugin.DDConstrained,{constrain2node:".archive-manager"});r.detach(),r.on("drag:start",function(){var e=this.get("dragNode"),t=this.get("node");t.setStyle("opacity",.25),e.set("innerHTML",t.getHTML()),e.addClass("block snapshot"),e.setStyle("opacity",.65)}),r.on("drag:end",function(){var e=this.get("node");e.setStyle("opacity","1")}),r.on("drag:drophit",function(e){var t=e.drag.get("node"),n=e.drop.get("node");M.local_rlsiteadmin.setup_archive(t,n)}),r.on("drag:dropmiss",function(e){})})}),setTimeout(function(){e.all("#rlarchives .archive").removeClass("slot-open")},3e3),e.one("#rlsnapshots .list").delegate("click",t,".snapshot .save")},discard_archive_init:function(){function t(){var e=this.ancestor(".archive");if(e.hasClass("restore-in-progress")||e.hasClass("restore-ready")){M.local_rlsiteadmin.show_error("archive_error_destroy_restore_first");return}if(e.hasClass("processing"))return;var t=confirm(M.util.get_string("archive_discard_confirmation","local_rlsiteadmin"));if(t){var n=e.getAttribute("data-archiveid");YUI().use("io-base","node",function(t){function r(){e.removeClass("processing")}function i(n,r){e.removeClass("processing");var i=null,s=r.responseText.match(/\{"archiveapi":{.*\}}/m);if(s===null){M.local_rlsiteadmin.show_error("archive_error_general");return}YUI().use("json-parse",function(e){try{i=e.JSON.parse(s[0])}catch(t){}});if(i.archiveapi.error)M.local_rlsiteadmin.show_error("archive_error_restore_in_progress");else if(i.archiveapi.httpcode==503)M.local_rlsiteadmin.show_error("archive_error_api_busy");else{e.setAttribute("data-archiveid",""),e.removeClass("archive"),e.addClass("slot"),e.addClass("slot-open"
);var o=t.one(".archive-manager .templates .slot").getHTML();e.set("innerHTML",o),M.local_rlsiteadmin.used_slots--,t.one("#rlarchives #numused").setHTML(M.local_rlsiteadmin.used_slots)}}function s(t){e.removeClass("processing")}t.on("io:complete",r,t,[]),t.on("io:success",i,t,[]),t.on("io:failure",s,t,[M.util.get_string("ajax_request_failed","local_rlsiteadmin")]);var o=M.cfg.wwwroot+"/local/rlsiteadmin/archive/apicall.php?request=discardarchive&archiveid="+n;t.io(o)})}}M.local_rlsiteadmin.bindings.discard&&M.local_rlsiteadmin.bindings.discard.detach(),M.local_rlsiteadmin.bindings.discard=e.one("#rlarchives .list").delegate("click",t,".archive .controls .discard")},setup_archive:function(e,t){if(!t.hasClass("slot-open"))return;var n=e.getAttribute("data-snapshotid");t.one(".info").hide(),t.removeClass("slot"),t.removeClass("slot-open"),t.addClass("archive"),e.hide(),YUI().use("io-base","node",function(r){function i(){}function s(i,s){var o=null,u=s.responseText.match(/\{"archiveapi":{.*\}}/m);if(u===null){M.local_rlsiteadmin.show_error("archive_error_general"),t.one(".info").show(),t.addClass("slot"),t.removeClass("archive"),e.show();return}YUI().use("json-parse",function(e){try{o=e.JSON.parse(u[0])}catch(t){}});if(o.archiveapi.error)M.local_rlsiteadmin.show_error("archive_error_no_slots_available"),t.one(".info").show(),t.addClass("slot"),t.addClass("slot-open"),t.removeClass("archive"),e.show();else if(o.archiveapi.httpcode==503)M.local_rlsiteadmin.show_error("archive_error_api_busy"),t.one(".info").show(),t.addClass("slot"),t.addClass("slot-open"),t.removeClass("archive"),e.show();else{t.setAttribute("data-archiveid",n);var a=r.one(".archive-manager .templates .archive").getHTML();t.set("innerHTML",a),t.one(".date").setHTML(e.one(".date").getHTML()),t.one(".status").setHTML(M.util.get_string("archive_status_in_progress","local_rlsiteadmin")),t.addClass("in-progress"),M.local_rlsiteadmin.used_slots++,r.one("#rlarchives #numused").setHTML(M.local_rlsiteadmin.used_slots),e.remove(),M.local_rlsiteadmin.discard_archive_init(),M.local_rlsiteadmin.restore_archive_init(),M.local_rlsiteadmin.show_info("archive_request_message")}}function o(e){}r.on("io:complete",i,r,[]),r.on("io:success",s,r,[]),r.on("io:failure",o,r,[M.util.get_string("ajax_request_failed","local_rlsiteadmin")]);var u=M.cfg.wwwroot+"/local/rlsiteadmin/archive/apicall.php?request=archivesnapshot&snapshotid="+n;r.io(u)})},restored_fetch:function(){YUI().use("io-base",function(e){function t(){}function n(e,t){var n=null,r=t.responseText.match(/\{"archiveapi":{.*\}}/m);if(r===null)return;YUI().use("json-parse",function(e){try{n=e.JSON.parse(r[0])}catch(t){}}),M.local_rlsiteadmin.data_restored=n.archiveapi.restored,M.local_rlsiteadmin.restored_write(),M.local_rlsiteadmin.restore_archive_init()}function r(e){}e.on("io:complete",t,e,[]),e.on("io:success",n,e,[]),e.on("io:failure",r,e,[M.util.get_string("ajax_request_failed","local_rlsiteadmin")]);var i=M.cfg.wwwroot+"/local/rlsiteadmin/archive/apicall.php?request=listrestored";e.io(i)})},restored_write:function(){var t=e.all("#rlarchives .archive");e.each(t,function(t,n){var r=t.getAttribute("data-archiveid");e.Object.each(M.local_rlsiteadmin.data_restored.done,function(e,n){if(r==e.id){t.addClass("restore-ready");var i='<a href="'+e.url+'">'+e.url+"</a>",s=e.expiration,o=M.util.get_string("archive_status_restored","local_rlsiteadmin")+i;o+=M.util.get_string("archive_available_until","local_rlsiteadmin")+s,t.one(".status").setHTML(o)}}),e.Object.each(M.local_rlsiteadmin.data_restored["in-progress"],function(n,i){r==n.id&&(t.addClass("restore-in-progress"),t.one(".status").setHTML(M.util.get_string("archive_status_restoring","local_rlsiteadmin")),t.one(".status .adminemail").setHTML(e.one("#useremail").getHTML()))})}),e.one("#rlarchives .count").addClass("show"),$spinner=e.one("#rlarchives .spinner"),$spinner.hide();var n=0,r=e.all("#rlarchives .block");e.each(r,function(e,t){n++,setTimeout(function(){e.removeClass("fadedout")},70*n)})},restore_archive_init:function(){function t(){var e=this.ancestor(".archive");if(e.hasClass("processing"))return;e.addClass("processing");var t=e.getAttribute("data-archiveid");e.hasClass("restore-in-progress")||e.hasClass("restore-ready")?r(t,e):n(t,e)}function n(e,t){YUI().use("io-base","node",function(n){function r(){t.removeClass("processing")}function i(e,r){t.removeClass("processing");var i=null,s=r.responseText.match(/\{"archiveapi":{.*\}}/m);if(s===null){M.local_rlsiteadmin.show_error("archive_error_general");return}YUI().use("json-parse",function(e){try{i=e.JSON.parse(s[0])}catch(t){}}),i.archiveapi.error?M.local_rlsiteadmin.show_error("archive_error_no_restore_slots_available"):i.archiveapi.httpcode==503?M.local_rlsiteadmin.show_error("archive_error_api_busy"):(t.addClass("restore-in-progress"),t.one(".status").setHTML(M.util.get_string("archive_status_restoring","local_rlsiteadmin")),t.one(".status .adminemail").setHTML(n.one("#useremail").getHTML()),M.local_rlsiteadmin.show_info("archive_request_message"))}function s(e){t.removeClass("processing")}n.on("io:complete",r,n,[]),n.on("io:success",i,n,[]),n.on("io:failure",s,n,[M.util.get_string("ajax_request_failed","local_rlsiteadmin")]);var o=M.cfg.wwwroot+"/local/rlsiteadmin/archive/apicall.php?request=restorearchive&archiveid="+e;n.io(o)})}function r(e,t){YUI().use("io-base","node",function(n){function r(){t.removeClass("processing")}function i(e,n){t.removeClass("processing");var r=null,i=n.responseText.match(/\{"archiveapi":{.*\}}/m);if(i===null){M.local_rlsiteadmin.show_error("archive_error_general");return}YUI().use("json-parse",function(e){try{r=e.JSON.parse(i[0])}catch(t){}}),r.archiveapi.error?M.local_rlsiteadmin.show_error("archive_error_no_restore_slots_available"):r.archiveapi.httpcode==503?M.local_rlsiteadmin.show_error("archive_error_api_busy"):(t.removeClass("restore-in-progress"),t.removeClass("restore-ready"),t.one(".status").setHTML(M.util.get_string("archive_status_ready","local_rlsiteadmin"
)))}function s(e){t.removeClass("processing")}n.on("io:complete",r,n,[]),n.on("io:success",i,n,[]),n.on("io:failure",s,n,[M.util.get_string("ajax_request_failed","local_rlsiteadmin")]);var o=M.cfg.wwwroot+"/local/rlsiteadmin/archive/apicall.php?request=destroyrestore&restoreid="+e;n.io(o)})}M.local_rlsiteadmin.bindings.restore&&M.local_rlsiteadmin.bindings.restore.detach(),M.local_rlsiteadmin.bindings.restore=e.one("#rlarchives .list").delegate("click",t,".archive .controls .power")},show_error:function(e){YUI().use("panel",function(t){M.local_rlsiteadmin.error_modal=new t.Panel({srcNode:"<div></div>",id:"error-modal",headerContent:M.util.get_string("archive_error_header","local_rlsiteadmin"),bodyContent:M.util.get_string(e,"local_rlsiteadmin"),buttons:[{id:"modal-confirm-button",label:M.util.get_string("close","local_rlsiteadmin"),section:"footer",action:function(e){e.preventDefault(),M.local_rlsiteadmin.error_modal.hide(),M.local_rlsiteadmin.error_modal.destroy()},classNames:"modal-confirm-button",disabled:!1}],classNames:"error-modal",width:400,height:200,zIndex:1e4,centered:!0,modal:!0,visible:!0,render:!0})})},show_info:function(e){YUI().use("panel",function(t){M.local_rlsiteadmin.error_modal=new t.Panel({srcNode:"<div></div>",id:"info-modal",headerContent:" ",bodyContent:M.util.get_string(e,"local_rlsiteadmin"),buttons:[{id:"modal-confirm-button",label:M.util.get_string("close","local_rlsiteadmin"),section:"footer",action:function(e){e.preventDefault(),M.local_rlsiteadmin.error_modal.hide(),M.local_rlsiteadmin.error_modal.destroy()},classNames:"modal-confirm-button",disabled:!1}],classNames:"info-modal",width:400,height:200,zIndex:1e4,centered:!0,modal:!0,visible:!0,render:!0})})},init:function(){e.all(".archive-error").size()==0&&(M.local_rlsiteadmin.snapshots_fetch(),M.local_rlsiteadmin.archives_fetch())}}},"@VERSION@",{requires:["base","node","panel","plugin","transition","event","event-delegate"]});
